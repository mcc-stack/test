<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Netty | 533实验室Java后端知识点整理</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="533实验室Java后端知识点整理">
    <link rel="preload" href="/test/assets/css/0.styles.363e3238.css" as="style"><link rel="preload" href="/test/assets/js/app.fb04842c.js" as="script"><link rel="preload" href="/test/assets/js/2.275389a7.js" as="script"><link rel="preload" href="/test/assets/js/21.43f72dd9.js" as="script"><link rel="prefetch" href="/test/assets/js/10.d306dbdb.js"><link rel="prefetch" href="/test/assets/js/11.3cb03267.js"><link rel="prefetch" href="/test/assets/js/12.913d7c94.js"><link rel="prefetch" href="/test/assets/js/13.888020c4.js"><link rel="prefetch" href="/test/assets/js/14.aa2ced95.js"><link rel="prefetch" href="/test/assets/js/15.17131c71.js"><link rel="prefetch" href="/test/assets/js/16.09c5f2c9.js"><link rel="prefetch" href="/test/assets/js/17.b5fb47e1.js"><link rel="prefetch" href="/test/assets/js/18.a85f24aa.js"><link rel="prefetch" href="/test/assets/js/19.e62c702b.js"><link rel="prefetch" href="/test/assets/js/20.de5fd22c.js"><link rel="prefetch" href="/test/assets/js/22.ea2b70ef.js"><link rel="prefetch" href="/test/assets/js/23.0dbebaf7.js"><link rel="prefetch" href="/test/assets/js/24.37c84f01.js"><link rel="prefetch" href="/test/assets/js/25.1104c8a2.js"><link rel="prefetch" href="/test/assets/js/3.44c5d363.js"><link rel="prefetch" href="/test/assets/js/4.a42ed78f.js"><link rel="prefetch" href="/test/assets/js/5.5558f3f5.js"><link rel="prefetch" href="/test/assets/js/6.af04c27c.js"><link rel="prefetch" href="/test/assets/js/7.dc65d060.js"><link rel="prefetch" href="/test/assets/js/8.25a2093a.js"><link rel="prefetch" href="/test/assets/js/9.2e34f20e.js">
    <link rel="stylesheet" href="/test/assets/css/0.styles.363e3238.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/test/" class="home-link router-link-active"><!----> <span class="site-name">533实验室Java后端知识点整理</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/test/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/lamarsan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/test/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/lamarsan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础部分</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>框架部分</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/test/框架部分/Spring5.html" class="sidebar-link">Spring5</a></li><li><a href="/test/框架部分/SpringBoot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/test/框架部分/MyBatis.html" class="sidebar-link">MyBatis</a></li><li><a href="/test/框架部分/Netty.html" class="active sidebar-link">Netty</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#netty-是什么-为什么要用-netty" class="sidebar-link">Netty 是什么，为什么要用 Netty</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#零拷贝是什么" class="sidebar-link">零拷贝是什么</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#netty-有什么组件" class="sidebar-link">Netty 有什么组件</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#粘包和半包问题" class="sidebar-link">粘包和半包问题</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#netty-的序列化问题" class="sidebar-link">Netty 的序列化问题</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#netty-线程模型" class="sidebar-link">Netty 线程模型</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#优雅退出" class="sidebar-link">优雅退出</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/Netty.html#内存分配" class="sidebar-link">内存分配</a></li></ul></li><li><a href="/test/框架部分/Nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/test/框架部分/消息中间件.html" class="sidebar-link">消息中间件</a></li><li><a href="/test/框架部分/Docker.html" class="sidebar-link">Docker</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="netty"><a href="#netty" class="header-anchor">#</a> Netty</h1> <h2 id="netty-是什么-为什么要用-netty"><a href="#netty-是什么-为什么要用-netty" class="header-anchor">#</a> Netty 是什么，为什么要用 Netty</h2> <p>Netty 是一款基于 NIO 开发的网络通信框架，在易用的同时，没有丧失可维护性和性能等优势。</p> <p>特点：高并发（NIO）、传输快（零拷贝）、封装好。</p> <h2 id="零拷贝是什么"><a href="#零拷贝是什么" class="header-anchor">#</a> 零拷贝是什么</h2> <p>零拷贝主要体现在三个方面：</p> <ol><li><p>Netty 的接受和发送 ByteBuffer 采用<strong>Direct Buffers</strong>，使用堆外直接内存进行 Socket 读写，不需要进行字节缓冲区的二次拷贝。</p></li> <li><p>提供了<strong>组合 Buffer 对象</strong>，可以聚合多个 ByteBuffer 对象，避免了传统通过内存拷贝将几个小 buffer 合并成一个大 Buffer。</p></li> <li><p>Netty 的文件传输采用了<strong>transferTo</strong>方法，它可以直接将<strong>文件缓冲区</strong>的数据发送到<strong>目标 Channel</strong>，避免了传统通过循环 write 方式导致的内存拷贝问题。</p></li></ol> <h2 id="netty-有什么组件"><a href="#netty-有什么组件" class="header-anchor">#</a> Netty 有什么组件</h2> <p><strong>Bootstrap</strong>: 引导类，提供一个用于应用程序网络层配置的容器。</p> <p><strong>Channel</strong>：底层网络传输 API 必须提供给 I/O 操作的接口。</p> <p><strong>ChannelHandler</strong>：channelHandler 支持很多协议，并且提供用于数据处理的容器。</p> <p><strong>ChannelInboundHandler</strong>:这个类型接收到入站事件（包括接收到的数据）可以处理应用程序逻辑</p> <p><strong>ChannelPipeline</strong>：提供一个容器给 channelHandler 链并提供一个 API 用于管理沿着链入站和出站事件的流动。每个 Channel 都有自己的 ChannelPipeline，是当 Channel 创建时自动被创建的。</p> <p><strong>EventLoop</strong>：用于处理 I/O 操作。一个单一的 EventLoop 通常会处理多个 Channel 事件。</p> <p><strong>EventLoopGroup</strong>：可以含有多于一个的 EventLoop 和提供一个迭代用于检索清单中的下一个。</p> <p><strong>ChannelFuture</strong>：Netty 所有的 I/O 操作都是异步的。因为一个操作可能无法立即返回，我们需要有一种方法在以后确定这个操作的返回结果。出于这个目的，Netty 提供了接口 ChannelFuture，它的 addLiListener 方法注册了一个 ChannelFutureListener，当操作完成时，可以被通知。</p> <p>关系：</p> <ol><li><p>Socket 和 Channel 是一对一。</p></li> <li><p>Channel 和 EventLoop 是多对一。</p></li> <li><p>EventLoop 和 EventLoopgroup 是多对一。</p></li> <li><p>EventLoop 和 Thread 是一对一。</p></li> <li><p>ChannelHandler 和 ChannelPipeline 是多对一。</p></li> <li><p>ChannelPipeline 和 Channel 是一对一。</p></li></ol> <h2 id="粘包和半包问题"><a href="#粘包和半包问题" class="header-anchor">#</a> 粘包和半包问题</h2> <p>粘包：发送方每次写入数据&lt;套接字缓冲区的大小；接收方读取数据不及时。</p> <p>半包：发送方每次写入数据&gt;套接字缓冲区的大小；发送的数据大于协议的最大传输单元，必须拆包。</p> <p>根本原因：TCP 是流式协议，消息无边界。</p> <p>解决方法：</p> <ol><li><p>改成短连接（不推荐）</p></li> <li><p>封装成帧（固定长度、分隔符、专门的 length 字段）</p></li></ol> <table><thead><tr><th>方式</th> <th>解码</th> <th>编码</th></tr></thead> <tbody><tr><td>固定长度</td> <td>FixedLengthFrameDecoder</td> <td>/</td></tr> <tr><td>分隔符</td> <td>DelimiterBasedFrameDecoder</td> <td>/</td></tr> <tr><td>专门的 length 字段</td> <td>LengthFieldBasedFrameDecoder</td> <td>LengthFieldPrepender</td></tr></tbody></table> <h2 id="netty-的序列化问题"><a href="#netty-的序列化问题" class="header-anchor">#</a> Netty 的序列化问题</h2> <ol><li><p>XML（较差）</p></li> <li><p>JSON</p></li> <li><p>Fastjson</p></li> <li><p>Thrift</p></li> <li><p>Avro（优秀）</p></li> <li><p>Protobuf（优秀）</p></li></ol> <h2 id="netty-线程模型"><a href="#netty-线程模型" class="header-anchor">#</a> Netty 线程模型</h2> <p>Netty 结合了 Selector 和 Reactor 模式设计了高效的线程模型，主要角色包括 Selector、EventLoopGroup/EventLoop、ChannelPipeline。</p> <p>首先，Selector 是一个多路复用器，负责将就绪的 IO 事件分离出来，BossEventLoopGroup 会负责接收，通常是一个单线程，根据事件分发到 WorkerEventLoopGroup，随后通过 ChannelPipeline 将请求进行处理，ChannelPipeline 内部是一个 ChannelHandler 链表，负责具体的处理。</p> <h2 id="优雅退出"><a href="#优雅退出" class="header-anchor">#</a> 优雅退出</h2> <ol><li><p>把 NIO 线程的状态位设置成 ST_SHUTTING_DOWN 状态，不再处理新的消息（不允许再对外发送消息）；</p></li> <li><p>退出前的预处理操作：把发送队列中尚未发送或者正在发送的消息发送完、把已经到期或者在退出超时之前到期的定时任务执行完成、把用户注册到 NIO 线程的退出 Hook 任务执行完成；</p></li> <li><p>资源的释放操作：所有 Channel 的释放、多路复用器的注册和关闭、所有队列和定时任务的清空取消，最后是 NIO 线程的退出。</p></li></ol> <h2 id="内存分配"><a href="#内存分配" class="header-anchor">#</a> 内存分配</h2> <p>主要分为 Arena、ChunkList、Chunk、Page、Subpage 这 5 个层级。</p> <ol><li><p>需要分配的内存小于 PageSize 时，分配 tiny 或者 small 内存。</p></li> <li><p>需要分配的内存介于 PageSize 和 ChunkSize 时，则分配 normal 内存。</p></li> <li><p>需要分配的内存大于 ChunkSize 时，则分配 huge 内存（非池化内存）。</p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/test/框架部分/MyBatis.html" class="prev">
        MyBatis
      </a></span> <span class="next"><a href="/test/框架部分/Nginx.html">
        Nginx
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/test/assets/js/app.fb04842c.js" defer></script><script src="/test/assets/js/2.275389a7.js" defer></script><script src="/test/assets/js/21.43f72dd9.js" defer></script>
  </body>
</html>
