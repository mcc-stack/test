<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息中间件 | 533实验室Java后端知识点整理</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="533实验室Java后端知识点整理">
    <link rel="preload" href="/test/assets/css/0.styles.363e3238.css" as="style"><link rel="preload" href="/test/assets/js/app.fb04842c.js" as="script"><link rel="preload" href="/test/assets/js/2.275389a7.js" as="script"><link rel="preload" href="/test/assets/js/9.2e34f20e.js" as="script"><link rel="prefetch" href="/test/assets/js/10.d306dbdb.js"><link rel="prefetch" href="/test/assets/js/11.3cb03267.js"><link rel="prefetch" href="/test/assets/js/12.913d7c94.js"><link rel="prefetch" href="/test/assets/js/13.888020c4.js"><link rel="prefetch" href="/test/assets/js/14.aa2ced95.js"><link rel="prefetch" href="/test/assets/js/15.17131c71.js"><link rel="prefetch" href="/test/assets/js/16.09c5f2c9.js"><link rel="prefetch" href="/test/assets/js/17.b5fb47e1.js"><link rel="prefetch" href="/test/assets/js/18.a85f24aa.js"><link rel="prefetch" href="/test/assets/js/19.e62c702b.js"><link rel="prefetch" href="/test/assets/js/20.de5fd22c.js"><link rel="prefetch" href="/test/assets/js/21.43f72dd9.js"><link rel="prefetch" href="/test/assets/js/22.ea2b70ef.js"><link rel="prefetch" href="/test/assets/js/23.0dbebaf7.js"><link rel="prefetch" href="/test/assets/js/24.37c84f01.js"><link rel="prefetch" href="/test/assets/js/25.1104c8a2.js"><link rel="prefetch" href="/test/assets/js/3.44c5d363.js"><link rel="prefetch" href="/test/assets/js/4.a42ed78f.js"><link rel="prefetch" href="/test/assets/js/5.5558f3f5.js"><link rel="prefetch" href="/test/assets/js/6.af04c27c.js"><link rel="prefetch" href="/test/assets/js/7.dc65d060.js"><link rel="prefetch" href="/test/assets/js/8.25a2093a.js">
    <link rel="stylesheet" href="/test/assets/css/0.styles.363e3238.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/test/" class="home-link router-link-active"><!----> <span class="site-name">533实验室Java后端知识点整理</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/test/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/lamarsan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/test/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/lamarsan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础部分</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>框架部分</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/test/框架部分/Spring5.html" class="sidebar-link">Spring5</a></li><li><a href="/test/框架部分/SpringBoot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/test/框架部分/MyBatis.html" class="sidebar-link">MyBatis</a></li><li><a href="/test/框架部分/Netty.html" class="sidebar-link">Netty</a></li><li><a href="/test/框架部分/Nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/test/框架部分/消息中间件.html" class="active sidebar-link">消息中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#消息中间件的概念以及和-rpc-的区别" class="sidebar-link">消息中间件的概念以及和 RPC 的区别</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#使用场景" class="sidebar-link">使用场景</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#各个消息中间件的对比" class="sidebar-link">各个消息中间件的对比</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#activemq" class="sidebar-link">ActiveMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#jms-规范" class="sidebar-link">JMS 规范</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#使用方法" class="sidebar-link">使用方法：</a></li></ul></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#rabbitmq" class="sidebar-link">RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#amqp-规范" class="sidebar-link">AMQP 规范</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#消息可靠性的保障" class="sidebar-link">消息可靠性的保障</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#消息分发的方式" class="sidebar-link">消息分发的方式</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#消息路由的方式" class="sidebar-link">消息路由的方式</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#broker-和-cluster" class="sidebar-link">Broker 和 Cluster</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#死信队列" class="sidebar-link">死信队列</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#使用方法-2" class="sidebar-link">使用方法：</a></li></ul></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#rocketmq" class="sidebar-link">RocketMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#高可用的保障" class="sidebar-link">高可用的保障</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#消息的可靠性" class="sidebar-link">消息的可靠性</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#nameserver-与-broker" class="sidebar-link">NameServer 与 Broker</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#分布式事务的支持" class="sidebar-link">分布式事务的支持</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#顺序性的保障" class="sidebar-link">顺序性的保障</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#使用方式" class="sidebar-link">使用方式：</a></li></ul></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#kafka" class="sidebar-link">Kafka</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#高可用" class="sidebar-link">高可用</a></li><li class="sidebar-sub-header"><a href="/test/框架部分/消息中间件.html#存活确认" class="sidebar-link">存活确认</a></li></ul></li></ul></li><li><a href="/test/框架部分/Docker.html" class="sidebar-link">Docker</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="消息中间件"><a href="#消息中间件" class="header-anchor">#</a> 消息中间件</h1> <h2 id="消息中间件的概念以及和-rpc-的区别"><a href="#消息中间件的概念以及和-rpc-的区别" class="header-anchor">#</a> 消息中间件的概念以及和 RPC 的区别</h2> <p><strong>概念：<strong>利用高效可靠的消息传递机制进行</strong>异步的数据传输</strong>，并基于数据通信进行分布式系统的集成。通过提供消息队列模型和消息传递机制，可以在分布式环境下扩展<strong>进程间的通信</strong>。</p> <p><strong>消息队列与 RPC：</strong></p> <table><thead><tr><th></th> <th>消息队列</th> <th>RPC</th></tr></thead> <tbody><tr><td>模式</td> <td>生产者消费者模式</td> <td>请求响应模式</td></tr> <tr><td>面向对象</td> <td>面向数据</td> <td>面向动作</td></tr> <tr><td>使用场景</td> <td>异步</td> <td>一般是远程同步调用</td></tr> <tr><td>有无存储</td> <td>有 broker 来存储消息</td> <td>没有存储，只有通信</td></tr> <tr><td>级别</td> <td>系统级、模块级的通信</td> <td>对象级、函数级的通信</td></tr></tbody></table> <h2 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h2> <ul><li><strong>解耦 ：</strong> 一个业务的非核心流程需要依赖其他系统，但结果并不重要，有通知即可。</li> <li><strong>最终一致性 ：</strong> 指的是两个系统的状态保持一致，可以有一定的延迟，只要最终达到一致性即可。经常用在解决分布式事务上。</li> <li><strong>广播 ：</strong> 消息队列最基本的功能。生产者只负责生产消息，订阅者接收消息。</li> <li><strong>错峰和流控</strong></li></ul> <h2 id="各个消息中间件的对比"><a href="#各个消息中间件的对比" class="header-anchor">#</a> 各个消息中间件的对比</h2> <table><thead><tr><th></th> <th>Kafka</th> <th>RocketMQ</th> <th>RabbitMQ</th></tr></thead> <tbody><tr><td><strong>设计定位</strong></td> <td>用于<strong>日志</strong>收集和传输</td> <td>非日志可靠消息传输。例如：订单、交易、充值、流计算、消息推送、流式处理、binglog 分发等</td> <td>可靠消息传输，类似 RocketMQ</td></tr> <tr><td><strong>客户端 SDK</strong></td> <td>Java, Scala, Go etc</td> <td>Java, C++, Go</td> <td>Java, .NET, C++ etc</td></tr> <tr><td><strong>持久化方式</strong></td> <td>磁盘文件</td> <td>磁盘文件</td> <td>内存、文件</td></tr> <tr><td><strong>集群管理</strong></td> <td>zk</td> <td>name server</td> <td>-</td></tr> <tr><td><strong>消息写入 性能</strong></td> <td>非常好，每条 10KB 测试，<strong>百万 TPS</strong></td> <td>很好，每条 10KB 测试，单机单 broker<strong>7wTPS</strong>，单机 3broker<strong>12wTPS</strong></td> <td>RAM 为 RocketMQ 的 1/2，DISK 为 RAM 的 1/3</td></tr> <tr><td><strong>性能稳定性</strong></td> <td>队列/分区多时性能不稳定，明显下降，消息堆积时性能稳定</td> <td>队列较多，消息堆积时性能稳定</td> <td>消息堆积时，性能不稳定，明显下降</td></tr> <tr><td><strong>事务消息</strong></td> <td>不支持</td> <td>支持</td> <td>不支持</td></tr> <tr><td><strong>评价</strong></td> <td>主要用于日志收集和传输，对消息的<strong>重复、丢失、错误</strong>没有严格要求，适合产生大量数据的互联网服务的数据收集业务</td> <td>具有高吞吐量、高可用性、适合大规模分布式系统应用，适合需要事务支持的交易系统</td> <td>在高吞吐量、高可用上不如 Kafka，RocketMQ，但是由于 erlang 语言特性，使用 RAM 模式时，性能也比较好，适合中等规模的数据场景</td></tr></tbody></table> <h2 id="activemq"><a href="#activemq" class="header-anchor">#</a> ActiveMQ</h2> <ol><li><p>ActiveMQ 是 Apache 出品，最流行的，能力强劲的开源消息总线，并且是一个完全支持 JMS（Java Message Service）规范的消息中间件。</p></li> <li><p>其丰富的 API、多种集群构建模式使得他称为业界老牌消息中间件，在中小型企业中应用广泛！</p></li> <li><p>MQ 衡量指标：服务性能、数据存储、集群架构。</p></li></ol> <h3 id="jms-规范"><a href="#jms-规范" class="header-anchor">#</a> JMS 规范</h3> <p>Java 消息服务（Java Message Server），是一个 Java 平台中关于面向消息中间件的 API，用于在两个应用程序之间或分布式系统中发送消息，进行<strong>异步通信</strong>。</p> <p><strong>相关概念：</strong></p> <ol><li>消息中间件（JMS Provider) ： 指提供了对 JMS 协议的第三方组件，比如 ActiveMQ 就是一个消息中间件；</li> <li>消息模式：分为点对点（Point to Point，即 P2P）和发布/订阅（Pub/Sub），对应的数据结构分别是队列（Queue）和主题（Topic）；</li> <li>消息（Message）：通信内容的载体，其结构主要分为消息头，属性和消息体，并且根据存储结构的不同分为好几种；</li> <li>消息生产者：产生消息的一方，在 P2P 模式下，指消息发送者（Sender），在 P/S 模式下指消息发布者（Publisher）；</li> <li>消息消费者：接收消息的一方，对应于两种模式分别是消息接收者（Receiver）和消息订阅者（Subscriber） 。</li></ol> <p><strong>相关接口：</strong></p> <p><img src="/test/assets/img/image-20200215155249209.93f4c7bb.png" alt="image-20200215155249209"></p> <h3 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> 使用方法：</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMQProducerQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">//1、创建工厂连接对象，需要制定ip和端口号</span>
    <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://x.x.x.x:61616&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、使用连接工厂创建一个连接对象</span>
    <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、开启连接</span>
    connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4、使用连接对象创建会话（session）对象</span>
    <span class="token class-name">Session</span> session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//5、使用会话对象创建目标对象，包含queue和topic（一对一和一对多）</span>
    <span class="token class-name">Queue</span> queue <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQueue</span><span class="token punctuation">(</span><span class="token string">&quot;test-queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//6、使用会话对象创建生产者对象</span>
    <span class="token class-name">MessageProducer</span> producer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createProducer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//7、使用会话对象创建一个消息对象</span>
    <span class="token class-name">TextMessage</span> textMessage <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createTextMessage</span><span class="token punctuation">(</span><span class="token string">&quot;hello!test-queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//8、发送消息</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>textMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//9、关闭资源</span>
    producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">TestMQConsumerQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">//1、创建工厂连接对象，需要制定ip和端口号</span>
    <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token string">&quot;tcp://192.168.156.44:61616&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、使用连接工厂创建一个连接对象</span>
    <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、开启连接</span>
    connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4、使用连接对象创建会话（session）对象</span>
    <span class="token class-name">Session</span> session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//5、使用会话对象创建目标对象，包含queue和topic（一对一和一对多）</span>
    <span class="token class-name">Queue</span> queue <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQueue</span><span class="token punctuation">(</span><span class="token string">&quot;test-queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//6、使用会话对象创建生产者对象</span>
    <span class="token class-name">MessageConsumer</span> consumer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//7、向consumer对象中设置一个messageListener对象，用来接收消息</span>
    consumer<span class="token punctuation">.</span><span class="token function">setMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO Auto-generated method stub</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>message <span class="token keyword">instanceof</span> <span class="token class-name">TextMessage</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">TextMessage</span> textMessage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TextMessage</span><span class="token punctuation">)</span>message<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>textMessage<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JMSException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// TODO Auto-generated catch block</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//8、程序等待接收用户消息</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//9、关闭资源</span>
    consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="rabbitmq"><a href="#rabbitmq" class="header-anchor">#</a> RabbitMQ</h2> <p>RabbitMQ 是使用 Erlang 语言开发的开源消息队列系统，基于 AMQP 协议来实现。AMQP 的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。AMQP 协议更多用在企业系统内，对数据一致性、稳定性和<strong>可靠性</strong>要求很高的场景，对性能和吞吐量的要求在其次。</p> <h3 id="amqp-规范"><a href="#amqp-规范" class="header-anchor">#</a> AMQP 规范</h3> <p>AMQP 全称：Advanced Message Queuing Protocol.</p> <p>AMQP 翻译：<strong>高级消息队列协议</strong>。</p> <p>AMQP 定义：二进制<strong>协议</strong>。是一个提供统一消息服务的<strong>应用层</strong>标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。</p> <p><img src="/test/assets/img/image-20200215160829688.53b52e64.png" alt="image-20200215160829688"></p> <p><strong>核心概念：</strong></p> <ul><li><strong>Server</strong>：又称 Broker，接受客户端的连接，实现 AMQP 实体服务。</li> <li><strong>Connection</strong>：连接，应用程序与 Broker 的网络连接。</li> <li><strong>Channel</strong>：网络信道，几乎所有的操作都在 Channel 中进行，Channel 是进行消息读写的通道。客户端可建立多个 Channel，每个 Channel 代表一个会话任务。</li> <li><strong>Message</strong>：消息，服务器和应用程序之间传送的数据，由 Properties 和 Body 组成。Properties 可以对消息进行修饰，比如消息的优先级、延迟等高级特性；Body 则就是消息体内容。</li> <li><strong>Virtual host</strong>：虚拟地址，用于进行逻辑隔离，最上层的消息路由。一个 Virtual Host 里面可以有若干个 Exchange 和 Queue，同一个 Virtual Host 里面不能有相同名称的 Exchange 和 Queue。</li> <li><strong>Exchange</strong>：交换机，接收消息，根据路由键转发消息到绑定的队列。</li> <li><strong>Binding</strong>：Exchange 和 Queue 之间的虚拟连接，binding 中可以包含 routing key。</li> <li><strong>Routing key</strong>：一个路由规则，虚拟机可用它来确定如何路由一个特定消息。</li> <li><strong>Queue</strong>：也称为 Message Queue，消息队列，保存消息并将它们转发给消费者。</li></ul> <h3 id="消息可靠性的保障"><a href="#消息可靠性的保障" class="header-anchor">#</a> 消息可靠性的保障</h3> <ul><li><p>发送方确认模式：</p> <ul><li><p>将<strong>信道</strong>（传输途径）设置成 confirm 模式（发送方确认模式），则所有在信道上发布的消息都会被<strong>指派一个唯一的 ID</strong>，这个会被用于<strong>去重</strong>。</p></li> <li><p>一旦消息被投递到目的队列后，或者消息被写入磁盘后（可持久化的消息），信道会发送一个确认给生产者（包含消息唯一 ID）。如果 RabbitMQ 发生内部错误从而导致消息丢失，会发送一条<strong>nack</strong>（not acknowledged，未确认）消息。</p></li></ul></li> <li><p>接收方确认机制：</p> <ul><li><p>消费者接收每一条消息后都<strong>必须进行确认</strong>（消息接收和消息确认是两个不同操作）。只有消费者确认了消息，RabbitMQ 才能安全地把消息从队列中删除。</p></li> <li><p>可以将消息持久化磁盘，防止丢失。</p></li></ul></li></ul> <h3 id="消息分发的方式"><a href="#消息分发的方式" class="header-anchor">#</a> 消息分发的方式</h3> <p>若该队列至少有一个消费者订阅，消息将以循环（round-robin）的方式发送给消费者。每条消息只会分发给一个订阅的消费者（前提是消费者能够正常处理消息并进行确认）。通过路由可实现多消费的功能。</p> <h3 id="消息路由的方式"><a href="#消息路由的方式" class="header-anchor">#</a> 消息路由的方式</h3> <p>消息提供方-&gt;路由-&gt;一至多个队列。</p> <p>消息发布到<strong>交换器</strong>时，消息将拥有一个<strong>路由键</strong>（routing key）。通过<strong>队列路由键</strong>，可以把队列绑定到交换器上。消息到达交换器后，RabbitMQ 会将<strong>消息的路由键</strong>与<strong>队列的路由键</strong>进行匹配。</p> <p>常用的交换器：</p> <ul><li>fanout：不需要路由键，如果交换器收到消息，将会广播到所有绑定的队列上，速度最快。</li> <li>direct：如果路由键<strong>完全匹配</strong>，消息就被投递到相应的队列。</li> <li>topic：可以用通配符进行<strong>模糊匹配</strong>，使来自不同源头的消息能够到达同一个队列。</li></ul> <h3 id="broker-和-cluster"><a href="#broker-和-cluster" class="header-anchor">#</a> Broker 和 Cluster</h3> <p>broker 是指一个或多个 erlang node 的逻辑分组，且 node 上运行着 RabbitMQ 应用程序。cluster 是在 broker 的基础之上，增加了 node 之间<strong>共享元数据</strong>的约束。</p> <h3 id="死信队列"><a href="#死信队列" class="header-anchor">#</a> 死信队列</h3> <p>死信队列的来源：</p> <ul><li><p>消息被拒绝（basic.reject/basic.nack）并且 requeue=false。</p></li> <li><p>消息 TTL 过期。</p></li> <li><p>队列达到最大长度。</p></li></ul> <p>利用 DLX，当消息在一个队列中变成死信（dead message）之后，它能被重新 publish 到另一个 Exchange，这个 Exchange 就是 DLX。</p> <h3 id="使用方法-2"><a href="#使用方法-2" class="header-anchor">#</a> 使用方法：</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建ConnectionFactory</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;x.x.x.x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过连接工厂创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过connection创建一个Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送数据</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;Hello!!!&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//The default exchange is implicitly bound to every queue, with a routing key equal to the queue name.</span>
        <span class="token comment">//It is not possible to explicitly bind to, or unbind from the default exchange. It also cannot be deleted.</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test001&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Sent '&quot;</span><span class="token operator">+</span>msg<span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//关闭连接</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建ConnectionFactory</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;x.x.x.x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过连接工厂创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过connection创建一个Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;test001&quot;</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; [*] Waiting for messages. To exit press CTRL+C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//以对象的形式提供一个回调，它将缓冲消息</span>
        <span class="token class-name">DeliverCallback</span> deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; [x] Received '&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="rocketmq"><a href="#rocketmq" class="header-anchor">#</a> RocketMQ</h2> <p>RocketMQ 是阿里开源的消息中间件，目前也已经孵化为 Apache 顶级项目，它是纯 Java 开发，具有高吞吐量、高可用性、适合大规模分布式系统应用的特点。RocketMQ 思路起源于 Kafka，它对消息的可靠性传输及事务性做了优化，目前在阿里集团被广泛应用于交易、充值、流计算、消息推送、日志流式处理、binglog 分发等场景。</p> <h3 id="高可用的保障"><a href="#高可用的保障" class="header-anchor">#</a> 高可用的保障</h3> <ul><li>多 Master 部署，防止单点故障。</li> <li>主从结构，消息冗余，防止消息丢失。</li></ul> <h3 id="消息的可靠性"><a href="#消息的可靠性" class="header-anchor">#</a> 消息的可靠性</h3> <ul><li>如果消息无法使用，将重传（最多重传 16 次）。</li> <li>使用分布式事务保证消息的可靠性。</li></ul> <h3 id="nameserver-与-broker"><a href="#nameserver-与-broker" class="header-anchor">#</a> NameServer 与 Broker</h3> <ul><li><p>Name Server 是一个几乎<strong>无状态</strong>（没有 leader 和 follower）的节点，可集群部署，节点之间无任何信息同步，主要功能是为整个 MQ 集群提供服务协调与治理，具体就是记录维护 Topic、Broker 的信息，及监控 Broker 的运行状态。</p></li> <li><p>Broker 部署相对复杂，Broker 分为 Master 与 Slave，一个 Master 可以对应多个 Slave，但是一个 Slave 只能对应一个 Master，Master 与 Slave 的对应关系通过指定相同的 BrokerName，不同的 BrokerId 来定义，<strong>BrokerId 为 0 表示 Master，非 0 表示 Slave</strong>。Master 也可以部署多个。</p> <p>每个 Broker 与 Name Server 集群中的所有节点建立<strong>长连接</strong>，定时注册 Topic 信息到所有 Name Server。</p></li></ul> <p><img src="/test/assets/img/image-20200215170132263.3170d77c.png" alt="image-20200215170132263"></p> <h3 id="分布式事务的支持"><a href="#分布式事务的支持" class="header-anchor">#</a> 分布式事务的支持</h3> <p>A（存在 DB 操作）、B（存在 DB 操作）两方需要保证分布式事务一致性，通过引入中间层 MQ，A 和 MQ 保持事务一致性（异常情况下通过 MQ 反查 A 接口实现 check），B 和 MQ 保证事务一致（通过重试），从而达到最终事务一致性。</p> <p><strong>大事务=小事务+异步：</strong></p> <p><img src="/test/assets/img/image-20200215170435937.cb598b00.png" alt="image-20200215170435937"></p> <h3 id="顺序性的保障"><a href="#顺序性的保障" class="header-anchor">#</a> 顺序性的保障</h3> <p>顺序消息（FIFO 消息）是 MQ 提供的一种严格按照顺序进行发布和消费的消息类型。顺序消息由两个部分组成：<strong>顺序发布</strong>和<strong>顺序消费</strong>。</p> <p>顺序消息包含两种类型：</p> <ol><li><p>分区顺序：一个 Partition 内所有的消息按照先进先出的顺序进行发布和消费。</p></li> <li><p>全局顺序：一个 Topic 内所有的消息按照先进先出的顺序进行发布和消费。</p></li></ol> <p><strong>具体思路：</strong></p> <p>生产端将同一订单的消息路由到特定的分区。PullMessageService 获取到消息后添加到 ProcessQueue 中，单线程执行，所以 ProcessQueue 中的消息是顺序的。消费者从 ProcessQueue 拿取消息，也是顺序的。</p> <h3 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式：</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//Instantiate with a producer group name.</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;please_rename_unique_group_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Specify name server addresses.</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Launch the instance.</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token comment">//Create a message instance, specifying topic, tag and message body.</span>
                <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;TagA&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;OrderID188&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%-10d OK %s %n&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span>
                            sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%-10d Exception %s %n&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//Shut down once the producer instance is not longer in use.</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>

        <span class="token comment">// Instantiate with specified consumer group name.</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">&quot;please_rename_unique_group_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Specify name server addresses.</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Subscribe one more more topics to consume.</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Register callback to execute on arrival of messages fetched from brokers.</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
                <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s Receive New Messages: %s %n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Launch the consumer instance.</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer Started.%n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="kafka"><a href="#kafka" class="header-anchor">#</a> Kafka</h2> <p>Kafka 是 Linkedln 开源的分布式发布-订阅消息系统，目前归属于 Apache 顶级项目。Kafka 主要特点是基于 Pull 的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输。0.8 版本开始支持复制，不支持事务，对消息的<strong>重复、丢失、错误</strong>没有严格要求，适合产生大量数据的互联网服务的数据收集业务。</p> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <ul><li><p>Broker</p> <p>kafka 集群由一个或多个 kafka server 组成，每个 server 即 Broker。</p> <p>Broker 是消息的代理，Producers 往 Brokers 里面的指定 Topic 中写消息，Consumers 从 Brokers 里面拉取指定 Topic 的消息，然后进行业务处理，broker 在中间起到一个代理保存消息的中转站。</p></li> <li><p>Topic</p> <p>逻辑概念。kafka 对消息保存时根据 Topic 进行归类，一个 Topic 可以认为是一类消息。</p></li> <li><p>Partition</p> <p>物理概念。每个 topic 将被分成一到多个 partition（分区），每个 partition 在存储层面就是一个 append log 文件。一个非常大的 topic 可以分成多个 partition，分布到多个 broker 上。kafka 只保证按一个 partition 中的顺序将消息发给 consumer，不保证一个 topic 的整体（多个 partition 间）的顺序。</p></li> <li><p>offset</p> <p>任何发布到 Partition 的消息都会被直接追加到 log 文件的尾部，每条消息在文件中的位置称为 offset（偏移量），offset 为一个 long 型数字，它是<strong>唯一标记一条消息</strong>。kafka 并没有提供其他额外的索引机制来存储 offset，因此在 kafka 中几乎不允许对消息进行“随机读写”。</p></li> <li><p>Consumer Group</p> <p>每个 consumer 属于一个特定的 consumer group（若不指定 group name 则属于默认的 group）。</p> <p>如果所有的 consumer 都具有相同的 group, 即单播，消息将会在 consumers 之间负载均衡；如果所有的 consumer 都具有不同的 group，那这就是&quot;发布-订阅&quot;，每条消息将会广播给所有的 consumer。</p></li></ul> <h3 id="高可用"><a href="#高可用" class="header-anchor">#</a> 高可用</h3> <p>Kafka 确保高可用的策略有 Data Replication 和 Leader Election。</p> <h4 id="leader-election"><a href="#leader-election" class="header-anchor">#</a> Leader Election</h4> <p>Kafka 的选举模式并不是少数服从多数，而是在 zookeeper 中动态维护了一个<strong>ISR</strong>（In-Sync Replicas)，ISR 中所有 Replica 都跟上了 Leader，只有 ISR 里的成员才有被选为 Leader 的可能</p> <p>选 Leader 的方案是：所有 Follower 都在 Zookeeper 上设置一个 Watch，一旦 Leader 宕机，其对应的 ephemeral znode 会自动删除，此时所有 Follower 都尝试创建该节点，而创建成功者（Zookeeper 保证只有一个能创建成功）即是新的 Leader，其它 Replica 即为 Follower。</p> <h4 id="data-replication"><a href="#data-replication" class="header-anchor">#</a> Data Replication</h4> <p>Producer 发布消息时，先找到 Partition 的 Leader Replica，并发送消息；Leader 写入 Log，其他的 Follower 会 pull 数据，保证数据的同步性，然后向 Leader 发送 ack 确认（实际上，每个 Follower 在接受到数据就会发送 ack，以提高性能），一旦 Leader 接收到了所有的 ISR 中的 Follower 的 ack 消息，就认为已经 commit 了。</p> <h3 id="存活确认"><a href="#存活确认" class="header-anchor">#</a> 存活确认</h3> <p>kafka 的存活条件包括两个条件：</p> <ol><li>kafka 必须维持着与 zookeeper 的 session（这个通过 zookeeper 的 heartbeat 机制来实现）</li> <li>follower 必须能够及时的将数据从 leader 复制过去 ，不能够“落后太多”。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/test/框架部分/Nginx.html" class="prev">
        Nginx
      </a></span> <span class="next"><a href="/test/框架部分/Docker.html">
        Docker
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/test/assets/js/app.fb04842c.js" defer></script><script src="/test/assets/js/2.275389a7.js" defer></script><script src="/test/assets/js/9.2e34f20e.js" defer></script>
  </body>
</html>
